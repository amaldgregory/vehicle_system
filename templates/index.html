<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>License Plate Detector</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      /* Eco-green palette */
      --bg1:#052e1b;         /* deep green */
      --bg2:#0b3d2a;         /* deep teal-green */
      --card:#06251acc;      /* glass card */
      --accent:#16a34a;      /* emerald-600 */
      --accent2:#84cc16;     /* lime-500 */
      --ok:#10b981;
      --bad:#ef4444;
      --muted:#a3b7ad;
      --text:#e6f4ec;
      --text-dim:#cfe6db;
      --ring:#1b4d38;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%, #22c55e40 0%, transparent 60%),
        radial-gradient(1000px 600px at 110% 10%, #84cc1640 0%, transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
    }
    .container{ max-width:1100px; margin:48px auto; padding:0 20px; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:22px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:44px; height:44px; border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display:grid; place-items:center; font-weight:800; color:white; letter-spacing:0.5px;
      box-shadow: 0 8px 24px #22c55e55;
    }
    .title{ font-size: clamp(22px, 2.4vw, 30px); font-weight:800; }
    .subtitle{ color:var(--text-dim); font-size:14px; margin-top:2px }
    .link-btn{
      text-decoration:none; color:white; background:linear-gradient(135deg, var(--accent), var(--accent2));
      padding:10px 14px; border-radius:10px; font-weight:700; box-shadow: 0 10px 30px #65a30d44;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .link-btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 34px #65a30d66; }

    .card{
      background: var(--card);
      backdrop-filter: blur(10px);
      border: 1px solid #ffffff12;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 30px #00000040, inset 0 0 0 1px #ffffff0f;
    }
    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:18px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

    .drop{
      border:2px dashed var(--ring);
      border-radius:14px;
      padding:18px;
      text-align:center;
      transition: border-color .2s ease, background .2s ease;
      min-height: 320px;               /* bigger box */
      display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px;
      cursor:pointer;
    }
    .drop.dragover{ border-color:#65a30d; background:#0b3d2a3a; }
    .hint{ color:var(--muted); font-size:14px }
    .actions{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:10px; }
    .btn{
      background:#0b3d2a; border:1px solid #ffffff1a; color:var(--text); padding:10px 14px; border-radius:10px;
      font-weight:700; cursor:pointer;
      transition: background .12s ease, transform .12s ease, border-color .12s ease;
    }
    .btn[disabled]{ opacity:.5; cursor:not-allowed }
    .btn.primary{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border:none; box-shadow: 0 10px 28px #22c55e33;
    }
    .btn.primary:hover{ transform: translateY(-1px) }

    .preview{
      width:100%; max-height: 520px;    /* taller preview */
      object-fit: contain; border-radius:12px; border:1px solid #ffffff15; background:#00000022;
    }

    .pill{ padding:6px 10px; border-radius:999px; font-weight:800; display:inline-block; letter-spacing:.3px; }
    .pill.ok{ background:#072d1f; color:#34d399; border:1px solid #10b98144 }
    .pill.bad{ background:#3b0f12; color:#f87171; border:1px solid #ef444444 }

    .row{
      display:grid; grid-template-columns: 140px 1fr; gap:10px; align-items:center; padding:8px 10px;
      border:1px solid #ffffff12; border-radius:12px; background:#0833242a;
    }
    .key{ color:var(--muted); font-size:13px }
    .val{ font-weight:700 }
    .chip{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background:#0b3d2a; border:1px solid #ffffff15; font-size:13px; color:var(--text-dim)
    }
    .spinner{
      width:18px; height:18px; border:3px solid #ffffff30; border-top-color:#fff; border-radius:50%;
      animation:spin 0.9s linear infinite; display:inline-block; vertical-align:-3px;
    }
    @keyframes spin{ to{ transform: rotate(360deg) } }
    .footer{ margin-top:20px; color:var(--muted); font-size:12px; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo">LP</div>
        <div>
          <div class="title">License Plate Detector</div>
          <div class="subtitle">Upload a vehicle photo to detect &amp; check 15-year ban</div>
        </div>
      </div>
      <a class="link-btn" href="/logger">ðŸ“‘ View Logs</a>
    </div>

    <div class="card">
      <div class="grid">
        <!-- LEFT: Upload -->
        <div>
          <div id="drop" class="drop">
            <div style="font-size:28px">ðŸ“·</div>
            <div><b>Drop an image here</b> or click to choose</div>
            <div class="hint">PNG, JPG, JPEG, BMP</div>
            <div class="actions">
              <input id="file" type="file" accept="image/*" hidden />
              <button id="pickBtn" class="btn">Choose File</button>
              <button id="uploadBtn" class="btn primary" disabled>Upload</button>
            </div>
            <div id="status" class="hint"></div>
          </div>
          <div style="margin-top:14px">
            <img id="preview" class="preview" alt="Preview will appear here" />
          </div>
        </div>

        <!-- RIGHT: Results -->
        <div>
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px">
            <div class="chip">ðŸ”Ž OCR + RC Check</div>
            <div id="banPill" class="pill" style="display:none"></div>
          </div>

          <div class="row"><div class="key">Raw Plate</div><div id="raw" class="val">â€”</div></div>
          <div class="row"><div class="key">Normalized</div><div id="norm" class="val">â€”</div></div>
          <div class="row"><div class="key">Make &amp; Model</div><div id="mkmd" class="val">â€”</div></div>
          <div class="row"><div class="key">Registration Year</div><div id="regy" class="val">â€”</div></div>
          <div class="row"><div class="key">Age</div><div id="age" class="val">â€”</div></div>
          <div class="row"><div class="key">API Status</div><div id="api" class="val">â€”</div></div>
        </div>
      </div>
    </div>

    <div class="footer">Tip: Sharper plate crops help OCR accuracy. Try to keep the plate frontal and well-lit.</div>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    const pickBtn   = document.getElementById('pickBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const drop      = document.getElementById('drop');
    const preview   = document.getElementById('preview');
    const statusEl  = document.getElementById('status');

    const rawEl  = document.getElementById('raw');
    const normEl = document.getElementById('norm');
    const mkmdEl = document.getElementById('mkmd');
    const regyEl = document.getElementById('regy');
    const ageEl  = document.getElementById('age');
    const apiEl  = document.getElementById('api');
    const banPill= document.getElementById('banPill');

    let currentFile = null;

    function setBusy(on){
      uploadBtn.disabled = on || !currentFile;
      statusEl.innerHTML = on ? '<span class="spinner"></span> Uploadingâ€¦' : '';
    }
    function setPreview(file){
      const url = URL.createObjectURL(file);
      preview.src = url;
    }
    function resetResults(){
      rawEl.textContent = 'â€”';
      normEl.textContent = 'â€”';
      mkmdEl.textContent = 'â€”';
      regyEl.textContent = 'â€”';
      ageEl.textContent = 'â€”';
      apiEl.textContent = 'â€”';
      banPill.style.display = 'none';
      banPill.textContent = '';
      banPill.className = 'pill';
    }
    function showResults(res){
      rawEl.textContent  = res.plate_raw || 'â€”';
      normEl.textContent = res.plate_normalized || 'â€”';
      mkmdEl.textContent = [res.make, res.model].filter(Boolean).join(' ') || 'â€”';
      regyEl.textContent = res.registration_year ?? 'â€”';
      ageEl.textContent  = (res.age ?? 'â€”');
      apiEl.textContent  = res.error ? ('Error: ' + res.error) : (res.make || res.model || res.registration_year ? 'OK' : 'No data');

      const banned = !!res.banned;
      banPill.style.display = 'inline-block';
      banPill.textContent = banned ? 'BANNED (Age â‰¥ 15y)' : 'ALLOWED';
      banPill.className = 'pill ' + (banned ? 'bad' : 'ok');
    }

    // --- Fix: prevent bubbling from buttons to the drop zone ---
    pickBtn.addEventListener('click', (e) => { e.stopPropagation(); fileInput.click(); });
    uploadBtn.addEventListener('click', (e) => { 
      e.stopPropagation(); 
      if(!currentFile) return; 
      doUpload(); 
    });

    fileInput.addEventListener('click', (e) => e.stopPropagation());

    drop.addEventListener('click', (e) => { if (e.target === drop) fileInput.click(); });

    fileInput.addEventListener('change', e => {
      const f = e.target.files?.[0];
      if(!f) return;
      currentFile = f;
      setPreview(f);
      resetResults();
      uploadBtn.disabled = false;
    });

    ['dragenter','dragover'].forEach(ev => {
      drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); });
    });
    ['dragleave','drop'].forEach(ev => {
      drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); });
    });
    drop.addEventListener('drop', e => {
      const f = e.dataTransfer.files?.[0];
      if(!f) return;
      if(!f.type.startsWith('image/')) { alert('Please drop an image'); return; }
      fileInput.files = e.dataTransfer.files;
      currentFile = f;
      setPreview(f);
      resetResults();
      uploadBtn.disabled = false;
    });

    async function doUpload(){
      setBusy(true);
      try{
        const fd = new FormData();
        fd.append('image', currentFile);
        const res = await fetch('/api/upload', { method:'POST', body: fd });
        const data = await res.json();
        showResults(data);
      }catch(err){
        apiEl.textContent = 'Network error';
      }finally{
        setBusy(false);
      }
    }
  </script>
</body>
</html>
